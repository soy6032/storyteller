<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.luxury.storyteller.mapper.ExaminationMapper">

    <select id="findExaminationChapterAll" resultType="com.luxury.storyteller.dto.ExaminationDto">
        SELECT * FROM examination_chapter;
    </select>

    <!--과목 목록(대분류)-->
    <select id="findExaminationMajorAll" resultType="com.luxury.storyteller.dto.ExaminationDto">
        SELECT * FROM examination_major;
    </select>

    <!--과목 상세-->
    <select id="findExaminationMajorByexaminationMajorIdx" parameterType="int" resultType="com.luxury.storyteller.dto.ExaminationDto">
        SELECT * FROM examination_major WHERE examination_major_idx = #{examinationMajorIdx};
    </select>

    <!-- 과목 수정 -->
    <update id="modifyExaminationMajor" parameterType="com.luxury.storyteller.dto.ExaminationDto">
        UPDATE examination_major
            SET examination_major_title = #{examinationMajorTitle}
        WHERE examination_major_idx = #{examinationMajorIdx}
    </update>

    <!--과목의 챕터(중분류)-->
    <select id="findExaminationChapterByExaminationMajorIdx" parameterType="int" resultType="com.luxury.storyteller.dto.ExaminationDto">
        SELECT * FROM examination_chapter where examination_major_idx = #{examinationMajorIdx};
    </select>

    <!--챕터 상세-->
    <select id="findExaminationChapterByExaminationChapterIdx" parameterType="int" resultType="com.luxury.storyteller.dto.ExaminationDto">
        SELECT * FROM examination_chapter where examination_chapter_idx = #{examinationChapterIdx};
    </select>

    <!-- 챕터 수정 -->
    <update id="modifyExaminationChapter" parameterType="com.luxury.storyteller.dto.ExaminationDto">
        UPDATE examination_chapter
            SET name = #{name}
        WHERE examination_chapter_idx = #{examinationChapterIdx}
    </update>

    <!--챕터의 번호별 문제-->
    <select id="findExaminationSelectByChapter" parameterType="com.luxury.storyteller.dto.ExaminationDto" resultType="com.luxury.storyteller.dto.ExaminationDto">
        SELECT *
        FROM
            examination_chapter AS chapter
            LEFT JOIN examination AS ex ON ex.examination_chapter_idx = chapter.examination_chapter_idx
            LEFT JOIN examination_select AS sel ON sel.examination_idx = ex.examination_idx
        WHERE chapter.examination_chapter_idx = 1 AND sel.examination_idx = 1
        ORDER BY ex.examination_idx, sel.examination_select_num
    </select>

    <!--챕터 모든 문제-->
    <select id="findExaminationByChapter" parameterType="int" resultType="com.luxury.storyteller.dto.ExaminationDto">
        SELECT *
            , ROW_NUMBER() OVER () AS question_number
        FROM luxury_storyteller.examination
        WHERE examination_chapter_idx = #{examinationChapterIdx};
    </select>

    <!--과목 등록-->
    <insert id="createExaminationMajor" parameterType="com.luxury.storyteller.dto.ExaminationDto">
        INSERT INTO examination_major (
            examination_major_title
        ) VALUES (
            #{examinationMajorTitle}
        )
    </insert>

    <!--챕터 등록-->
    <insert id="createExaminationChapter" parameterType="com.luxury.storyteller.dto.ExaminationDto">
        INSERT INTO examination_chapter (
            examination_major_idx, name
        ) VALUES (
            #{examinationMajorIdx}, #{name}
        )
    </insert>

    <!--문제 등록-->
    <insert id="createExamination" parameterType="com.luxury.storyteller.dto.ExaminationDto">
        <selectKey keyProperty="examinationIdx" order="AFTER" resultType="int">
            SELECT LAST_INSERT_ID()
        </selectKey>
        INSERT INTO examination (
            examination_chapter_idx, question, answer
        ) VALUES (
            #{examinationChapterIdx}, #{question}, #{answer}
        )
    </insert>

    <!--문제 항목 등록-->
    <insert id="createExaminationSelect" parameterType="com.luxury.storyteller.dto.ExaminationDto">
        INSERT INTO examination_select (
            examination_idx, examination_select_num, examination_select_title
        ) VALUES (
            #{examinationIdx}, #{examinationSelectNum}, #{examinationSelectTitle}
        )
    </insert>
</mapper>
